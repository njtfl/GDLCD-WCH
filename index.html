<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蓝牙图像处理工具</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #image-canvas {
            max-width: 100%;
            background-color: #f8fafc;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .slider-container {
            background: #f0f0f0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85rem;
        }

        .slider-value {
            font-weight: bold;
            color: #3b82f6;
            min-width: 40px;
            text-align: right;
        }

        .slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #d1d5db;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
        }

        .color-swatch {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .bluetooth-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white"><path d="M14.24 12.01l2.32 2.32c.28-.72.44-1.51.44-2.33 0-.82-.16-1.59-.43-2.31l-2.33 2.32zm5.29-5.3l-1.26 1.26c.63 1.21.98 2.57.98 4.02s-.36 2.82-.98 4.02l1.2 1.2c.97-1.54 1.54-3.36 1.54-5.31-.01-1.89-.55-3.67-1.48-5.19zm-3.82 1L10 2H9v7.59L4.41 5 3 6.41 8.59 12 3 17.59 4.41 19 9 14.41V22h1l5.71-5.71-4.3-4.29 4.3-4.29zM11 5.83l1.88 1.88L11 9.59V5.83zm1.88 10.46L11 18.17v-3.76l1.88 1.88z"/></svg>');
            margin-right: 8px;
        }

        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background-color: #f8fafc;
        }

        .upload-area:hover,
        .upload-area.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .preview-container {
            width: 100%;
            text-align: center;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background-color: #f8fafc;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .canvas-wrapper {
            display: inline-block;
            position: relative;
            margin: 0 auto;
            max-width: 100%;
            overflow: auto;
        }

        .canvas-size-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .progress-container {
            height: 10px;
            background-color: #e5e7eb;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
        }

        .transfer-stats {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 5px;
        }

        .mode-description {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .connected-device {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            border-radius: 8px;
            padding: 12px;
            margin-top: 12px;
        }

        .section-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .btn-success {
            background: linear-gradient(to right, #10b981, #059669);
            color: white;
        }

        .btn-success:hover {
            background: linear-gradient(to right, #059669, #047857);
        }

        .btn-warning {
            background: linear-gradient(to right, #f59e0b, #d97706);
            color: white;
        }

        .btn-warning:hover {
            background: linear-gradient(to right, #d97706, #b45309);
        }

        .btn-danger {
            background: linear-gradient(to right, #ef4444, #dc2626);
            color: white;
        }

        .btn-danger:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
        }

        .grid-cols-auto {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        @media (max-width: 768px) {
            .grid-cols-auto {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="text-center mb-2">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">蓝牙图像处理传输</h1>
        <!-- <p class="text-gray-600">支持大文件传输、多色模式及抖动算法调节</p> -->
        </div>

        <!-- 图像预览区域 -->
        <div class="section-card">
            <h2 class="section-title">图像预览</h2>
            <div class="preview-container">
                <div class="canvas-wrapper">
                    <canvas id="image-canvas"></canvas>
                    <div class="canvas-size-indicator" id="canvas-size-indicator">800×480</div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-auto gap-6">
            <!-- 左侧面板 -->
            <div>
                <!-- 图片上传 -->
                <div class="section-card">
                    <h2 class="section-title">图片上传</h2>
                    <div class="upload-area" id="upload-area">
                        <div class="upload-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                            </svg>
                        </div>
                        <p class="mt-2 text-sm text-gray-600">拖放图片到此处或点击上传</p>
                        <p class="text-xs text-gray-500 mt-1">支持 JPG, PNG, GIF 格式</p>
                    </div>
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                </div>

                <!-- 画布设置 -->
                <div class="section-card">
                    <h2 class="section-title">画布设置</h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="canvasWidth" class="block text-sm font-medium text-gray-700 mb-1">宽度</label>
                            <input type="number" id="canvasWidth" value="122" min="100" max="2000"
                                class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label for="canvasHeight" class="block text-sm font-medium text-gray-700 mb-1">高度</label>
                            <input type="number" id="canvasHeight" value="250" min="100" max="2000"
                                class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <div class="mt-4">
                        <button id="update-canvas" class="w-full btn-primary py-2">
                            更新画布尺寸
                        </button>
                    </div>
                </div>

                <!-- 设备绑定 -->
                <div class="section-card">
                    <h2 class="section-title">蓝牙设备绑定</h2>
                    <button id="scan-bluetooth" class="w-full btn-primary py-3 flex justify-center items-center">
                        <svg class="w-5 h-5 mr-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        搜索蓝牙设备
                    </button>
                    <!-- 新增断开蓝牙连接按钮 -->
                    <button id="disconnect-bluetooth" class="w-full btn-danger py-3 flex justify-center items-center mt-2">
                        <svg class="w-5 h-5 mr-2 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                               d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        断开蓝牙连接
                    </button>
                    <div id="device-list" class="mt-4"></div>
                </div>
            </div>

            <!-- 右侧面板 -->
            <div>
                <!-- 图片处理 -->
                <div class="section-card">
                    <h2 class="section-title">图片处理</h2>

                    <!-- 处理模式 -->
                    <div class="mb-4">
                        <label for="ditherMode" class="block text-sm font-medium text-gray-700 mb-2">处理模式</label>
                        <select id="ditherMode"
                            class="w-full p-3 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500">
                            <option value="blackWhiteColor">
                                黑白模式
                            </option>
                            <option value="threeColor">
                                黑白红三色
                            </option>
                            <option value="fourColor">
                                黑白红黄四色
                            </option>
                            <option value="sixColor">
                                六色模式
                            </option>
                        </select>
                        <div class="mode-description">
                            <div id="mode-description-text">
                                黑白模式：将图像转换为黑白两色，适合单色墨水屏显示
                            </div>
                        </div>
                    </div>

                    <!-- 抖动算法调节 -->
                    <div class="mb-4">
                        <h3 class="text-md font-medium text-gray-700 mb-3">抖动算法调节</h3>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>饱和度</span>
                                <span class="slider-value" id="saturation-value">1.0</span>
                            </div>
                            <input type="range" id="saturation-slider" min="0" max="2" step="0.1" value="1.0"
                                class="slider">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>亮度</span>
                                <span class="slider-value" id="brightness-value">1.0</span>
                            </div>
                            <input type="range" id="brightness-slider" min="0" max="2" step="0.1" value="1.0"
                                class="slider">
                        </div>

                        <div class="slider-container">
                            <div class="slider-label">
                                <span>对比度</span>
                                <span class="slider-value" id="contrast-value">1.0</span>
                            </div>
                            <input type="range" id="contrast-slider" min="0" max="2" step="0.1" value="1.0"
                                class="slider">
                        </div>

                        <!-- 新增扩散程度调节 -->
                        <div class="slider-container">
                            <div class="slider-label">
                                <span>扩散程度</span>
                                <span class="slider-value" id="diffusion-value">1.0</span>
                            </div>
                            <input type="range" id="diffusion-slider" min="0" max="1" step="0.1" value="1.0"
                                class="slider">
                        </div>
                    </div>

                    <button id="process-image" class="w-full btn-success py-3">
                        处理图片
                    </button>
                </div>

                <!-- 操作按钮 -->
                <div class="section-card">
                    <h2 class="section-title">数据传输</h2>

                    <div class="mb-4">
                        <div class="progress-container">
                            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                        </div>
                        <div class="transfer-stats">
                            <span id="transfer-status">等待传输</span>
                            <span id="transfer-speed">0 KB/s</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button id="send-bluetooth" class="btn-primary flex items-center justify-center">
                            <span class="bluetooth-icon"></span>
                            蓝牙发送
                        </button>
                        <button id="export-c-array" class="btn-warning">
                            导出C数组
                        </button>
                        <button id="reset-all" class="btn-danger col-span-1 md:col-span-2">
                            重置所有设置
                        </button>
                    </div>
                </div>

                <!-- 状态信息 -->
                <div class="section-card">
                    <h2 class="section-title">系统状态</h2>
                    <div class="text-sm text-gray-600">
                        <div class="mb-2 flex justify-between">
                            <span class="font-medium">当前画布尺寸：</span>
                            <span id="current-canvas-size">800×480</span>
                        </div>
                        <div class="mb-2 flex justify-between">
                            <span class="font-medium">当前模式：</span>
                            <span id="current-mode">黑白模式</span>
                        </div>
                        <div class="mb-2 flex justify-between">
                            <span class="font-medium">图像状态：</span>
                            <span id="image-status">未上传</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium">蓝牙状态：</span>
                            <span id="bluetooth-status">未连接</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 状态指示器 -->
        <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
            <div class="bg-white rounded-xl p-6 flex flex-col items-center">
                <div class="loader"></div>
                <p class="mt-4 font-medium" id="loading-text">处理中，请稍候...</p>
            </div>
        </div>

        <div id="error-message"
            class="fixed bottom-4 right-4 bg-red-500 text-white p-3 rounded-md shadow-lg hidden max-w-xs z-50"></div>
    </div>

    <script>
        // 绑定元素
        const scanBluetoothButton = document.getElementById('scan-bluetooth');
        const deviceList = document.getElementById('device-list');
        const uploadArea = document.getElementById('upload-area');
        const imageUploadInput = document.getElementById('image-upload');
        const canvasWidthInput = document.getElementById('canvasWidth');
        const canvasHeightInput = document.getElementById('canvasHeight');
        const updateCanvasButton = document.getElementById('update-canvas');
        const ditherModeSelect = document.getElementById('ditherMode');
        const processImageButton = document.getElementById('process-image');
        const sendBluetoothButton = document.getElementById('send-bluetooth');
        const exportCArrayButton = document.getElementById('export-c-array');
        const resetAllButton = document.getElementById('reset-all');
        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const loading = document.getElementById('loading');
        const loadingText = document.getElementById('loading-text');
        const errorMessage = document.getElementById('error-message');
        const canvasSizeIndicator = document.getElementById('canvas-size-indicator');
        const currentCanvasSize = document.getElementById('current-canvas-size');
        const currentMode = document.getElementById('current-mode');
        const imageStatus = document.getElementById('image-status');
        const bluetoothStatus = document.getElementById('bluetooth-status');
        const modeDescriptionText = document.getElementById('mode-description-text');
        const progressBar = document.getElementById('progress-bar');
        const transferStatus = document.getElementById('transfer-status');
        const transferSpeed = document.getElementById('transfer-speed');

        // 新增绑定断开蓝牙连接按钮
        const disconnectBluetoothButton = document.getElementById('disconnect-bluetooth');

        // 抖动算法调节元素
        const saturationSlider = document.getElementById('saturation-slider');
        const brightnessSlider = document.getElementById('brightness-slider');
        const contrastSlider = document.getElementById('contrast-slider');
        const diffusionSlider = document.getElementById('diffusion-slider');
        const saturationValue = document.getElementById('saturation-value');
        const brightnessValue = document.getElementById('brightness-value');
        const contrastValue = document.getElementById('contrast-value');
        const diffusionValue = document.getElementById('diffusion-value');

        // 存储原始图像和原始图像数据
        let originalImage = null;
        let originalImageData = null;
        let processedImageData = null;
        let connectedDevice = null;
        let connectedCharacteristic = null;
        let isTransferring = false;
        let transferStartTime = 0;
        //新增全局变量
        let bluetoothDevice = null;
        let gattServer = null;
        let writeCharacteristic = null;

        // 模式描述映射
        const modeDescriptions = {
            'blackWhiteColor': '黑白模式：将图像转换为黑白两色，适合单色墨水屏显示',
            'threeColor': '黑白红三色模式：支持黑色、白色和红色，适合三色墨水屏',
            'fourColor': '黑白红黄四色模式：支持黑色、白色、红色和黄色',
            'sixColor': '六色模式：支持黑色、白色、红色、黄色、蓝色和绿色'
        };

        // 模式名称映射
        const modeNames = {
            'blackWhiteColor': '黑白模式',
            'threeColor': '黑白红三色',
            'fourColor': '黑白红黄四色',
            'sixColor': '六色模式'
        };


        // ===== 添加这个函数 =====
        function updateBluetoothStatus() {
        if (bluetoothDevice && gattServer && gattServer.connected) {
            // 从设备ID中提取MAC地址的最后两位
            let macSuffix = '';
            if (bluetoothDevice.id) {
                const parts = bluetoothDevice.id.split(':');
                if (parts.length >= 6) {
                    macSuffix = parts[4] + parts[5];
                    macSuffix = macSuffix.toUpperCase();
                }
            }
            
            // 构建完整显示名称
            let baseName = bluetoothDevice.name || 'WCH_BLE';
            if (!baseName.endsWith(macSuffix) && macSuffix) {
                baseName = `${baseName}_${macSuffix}`;
            }
            
            bluetoothStatus.textContent = `已连接: ${baseName}`;
            
            // 更新设备列表显示
            deviceList.innerHTML = `
                <div class="connected-device">
                    <svg class="w-5 h-5 text-green-500 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="font-medium">已连接: ${baseName}</span>
                </div>
            `;
            
            disconnectBluetoothButton.disabled = false;
        } else {
            bluetoothStatus.textContent = '未连接';
            deviceList.innerHTML = '';
            disconnectBluetoothButton.disabled = true;
        }
    }


        // 更新滑块值显示
        function updateSliderValues() {
            saturationValue.textContent = saturationSlider.value;
            brightnessValue.textContent = brightnessSlider.value;
            contrastValue.textContent = contrastSlider.value;
            diffusionValue.textContent = diffusionSlider.value;
        }

        saturationSlider.addEventListener('input', updateSliderValues);
        brightnessSlider.addEventListener('input', updateSliderValues);
        contrastSlider.addEventListener('input', updateSliderValues);
        diffusionSlider.addEventListener('input', updateSliderValues);

        // 显示加载动画
        function showLoading(text = "处理中，请稍候...") {
            loadingText.textContent = text;
            loading.classList.remove('hidden');
        }

        // 隐藏加载动画
        function hideLoading() {
            loading.classList.add('hidden');
        }

        // 显示错误提示
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => {
                errorMessage.classList.add('hidden');
            }, 5000);
        }

        // 更新状态信息
        function updateStatusInfo() {
            const width = canvas.width;
            const height = canvas.height;
            currentCanvasSize.textContent = `${width}×${height}`;
            canvasSizeIndicator.textContent = `${width}×${height}`;
            currentMode.textContent = modeNames[ditherModeSelect.value];
            modeDescriptionText.textContent = modeDescriptions[ditherModeSelect.value];

            if (originalImage) {
                imageStatus.textContent = '已上传';
            } else {
                imageStatus.textContent = '未上传';
            }

            if (connectedDevice) {
                bluetoothStatus.textContent = `已连接: ${connectedDevice.name}`;
            } else {
                bluetoothStatus.textContent = '未连接';
            }
        }

        // 搜索并连接蓝牙设备
        scanBluetoothButton.addEventListener('click', async () => {
            if (isTransferring) {
                showError("请等待当前传输完成");
                return;
            }

            try {
                showLoading("正在搜索蓝牙设备...");

                if (!navigator.bluetooth) {
                    showError('您的浏览器不支持 Web Bluetooth API！');
                    return;
                }

                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
                });

                loadingText.textContent = "正在连接设备...";
                const server = await device.gatt.connect();

                loadingText.textContent = "正在获取服务...";
                const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');

                loadingText.textContent = "正在获取特征值...";
                const characteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');

                if (!characteristic.properties.write) {
                    throw new Error('特征值不支持写入操作');
                }

                connectedDevice = device;
                connectedCharacteristic = characteristic;

                // 显示连接成功的设备
                deviceList.innerHTML = `
                    <div class="connected-device">
                        <svg class="w-5 h-5 text-green-500 mr-2 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                        </svg>
                        <span class="font-medium">已连接: ${device.name}</span>
                    </div>
                `;

                updateStatusInfo();
            } catch (error) {
                console.error('Error:', error);
                showError(`连接失败：${error.message}`);
            } finally {
                hideLoading();
            }
        });


        // 断开蓝牙连接函数
        disconnectBluetoothButton.addEventListener('click', () => {
            if (isTransferring) {
                showError("请等待当前传输完成");
                return;
            }

            if (connectedDevice) {
                try {
                    connectedDevice.gatt.disconnect();
                    connectedDevice = null;
                    connectedCharacteristic = null;
                    deviceList.innerHTML = '';
                    updateStatusInfo();
                    showError('蓝牙连接已断开！');
                } catch (error) {
                    console.error('Error:', error);
                    showError(`断开连接失败：${error.message}`);
                }
            } else {
                showError('当前没有连接的蓝牙设备！');
            }
        });


        // 修复拖放上传功能
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');

            const file = e.dataTransfer.files[0];
            if (file && file.type.match('image.*')) {
                handleImageUpload(file);
            } else {
                showError('请上传有效的图片文件！');
            }
        });

        uploadArea.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                handleImageUpload(file);
            }
        });

        function handleImageUpload(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                originalImage = new Image();
                originalImage.onload = function () {
                    updateCanvas();
                    updateStatusInfo();
                };
                originalImage.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // 更新画布
        function updateCanvas() {
            if (!originalImage) return;

            const canvasWidth = parseInt(canvasWidthInput.value) || 800;
            const canvasHeight = parseInt(canvasHeightInput.value) || 480;

            // 设置canvas的实际尺寸
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            const imgWidth = originalImage.width;
            const imgHeight = originalImage.height;
            const scale = Math.max(canvas.width / imgWidth, canvas.height / imgHeight);
            const scaledWidth = imgWidth * scale;
            const scaledHeight = imgHeight * scale;
            const cropX = (scaledWidth - canvas.width) / 2;
            const cropY = (scaledHeight - canvas.height) / 2;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(
                originalImage,
                cropX / scale, cropY / scale,
                canvas.width / scale, canvas.height / scale,
                0, 0,
                canvas.width, canvas.height
            );

            // 保存原始图像数据用于后续处理
            originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            updateStatusInfo();
        }

        // 当画布尺寸变化时更新图像
        updateCanvasButton.addEventListener('click', updateCanvas);

        // 重置所有设置
        resetAllButton.addEventListener('click', () => {
            if (isTransferring) {
                showError("请等待当前传输完成");
                return;
            }

            // 重置滑块
            saturationSlider.value = 1.0;
            brightnessSlider.value = 1.0;
            contrastSlider.value = 1.0;
            diffusionSlider.value = 1.0;
            updateSliderValues();

            // 重置画布尺寸
            canvasWidthInput.value = 122; 
            canvasHeightInput.value = 250;

            // 重置模式选择
            ditherModeSelect.value = 'blackWhiteColor';

            // 清除图片
            originalImage = null;
            originalImageData = null;
            processedImageData = null;

            // 重置画布
            canvas.width = 122;
            canvas.height = 250;
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('上传图片后预览将显示在这里', canvas.width / 2, canvas.height / 2);

            // 清除蓝牙连接
            connectedDevice = null;
            connectedCharacteristic = null;
            deviceList.innerHTML = '';

            // 重置传输状态
            progressBar.style.width = '0%';
            transferStatus.textContent = '等待传输';
            transferSpeed.textContent = '0 KB/s';

            updateStatusInfo();
            showError('所有设置已重置！');
        });

        // 处理图片 - 修复按钮多次点击问题
        processImageButton.addEventListener('click', () => {
            if (!originalImageData) {
                showError('请先上传图片！');
                return;
            }

            showLoading("正在处理图片...");
            setTimeout(() => {
                const saturation = parseFloat(saturationSlider.value);
                const brightness = parseFloat(brightnessSlider.value);
                const contrast = parseFloat(contrastSlider.value);
                const diffusion = parseFloat(diffusionSlider.value);

                // 使用原始图像数据创建副本进行处理
                processedImageData = new ImageData(
                    new Uint8ClampedArray(originalImageData.data),
                    originalImageData.width,
                    originalImageData.height
                );

                ditherImage(processedImageData, saturation, brightness, contrast, diffusion);
                ctx.putImageData(processedImageData, 0, 0);
                hideLoading();
            }, 0);
        });

        // 导出 C 数组
        exportCArrayButton.addEventListener('click', () => {
            if (!processedImageData) {
                showError('请先处理图片！');
                return;
            }

            const cArray = processImageData(processedImageData);
            const blob = new Blob([cArray], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'image_array.c';
            a.click();
            URL.revokeObjectURL(url);
        });

        // 通过蓝牙发送数据 (支持大文件分块传输)
        sendBluetoothButton.addEventListener('click', async () => {
            if (isTransferring) {
                showError("传输正在进行中，请稍候");
                return;
            }

            if (!connectedDevice || !connectedCharacteristic) {
                showError('请先连接蓝牙设备！');
                return;
            }

            if (!processedImageData) {
                showError('请先处理图片！');
                return;
            }

            try {
                isTransferring = true;
                showLoading("正在准备传输...");

                const cArray = processImageData(processedImageData);
                const chunkSize = 244; // 最大512字节
                const totalBytes = cArray.length;
                let sentBytes = 0;

                // 重置进度条
                progressBar.style.width = '0%';
                transferStatus.textContent = '开始传输...';
                transferSpeed.textContent = '0 KB/s';

                transferStartTime = Date.now();

                for (let i = 0; i < totalBytes; i += chunkSize) {
                    if (!isTransferring) break; // 允许取消

                    const startTime = Date.now();
                    const end = Math.min(i + chunkSize, totalBytes);
                    const chunk = cArray.slice(i, end);

                    // 更新传输状态
                    sentBytes += chunk.length;
                    const progress = Math.round((sentBytes / totalBytes) * 100);
                    progressBar.style.width = `${progress}%`;
                    transferStatus.textContent = `传输中: ${sentBytes}/${totalBytes} 字节`;

                    // 计算传输速度
                    const elapsedTime = (Date.now() - transferStartTime) / 1000; // 秒
                    const speed = elapsedTime > 0 ? (sentBytes / 1024 / elapsedTime).toFixed(2) : 0;
                    transferSpeed.textContent = `${speed} KB/s`;

                    // 更新加载文本
                    loadingText.textContent = `发送数据 ${sentBytes}/${totalBytes} 字节 (${speed} KB/s)`;

                    // 发送数据块
                    await connectedCharacteristic.writeValue(chunk);

                    // 添加延迟以避免阻塞
                    await new Promise(resolve => setTimeout(resolve, 10));
                }

                if (isTransferring) {
                    transferStatus.textContent = '传输完成!';
                    showError('数据发送成功！');
                }
            } catch (error) {
                console.error('Error:', error);
                transferStatus.textContent = '传输失败';
                showError(`发送失败：${error.message}`);
            } finally {
                isTransferring = false;
                hideLoading();
            }
        });

        // 抖动算法实现（增加扩散程度参数）
        function ditherImage(imageData, saturation = 1, brightness = 1, contrast = 1, diffusion = 1) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const mode = ditherModeSelect.value;
            let palette;

            // 选择调色板
            if (mode === 'sixColor') {
                palette = [
                    { r: 0, g: 0, b: 0 },       // black
                    { r: 255, g: 255, b: 255 }, // white
                    { r: 255, g: 0, b: 0 },     // red
                    { r: 255, g: 255, b: 0 },   // yellow
                    { r: 0, g: 255, b: 0 },     // green
                    { r: 0, g: 0, b: 255 }      // blue
                ];
            } else if (mode === 'fourColor') {
                palette = [
                    { r: 0, g: 0, b: 0 },       // black
                    { r: 255, g: 255, b: 255 }, // white
                    { r: 255, g: 0, b: 0 },     // red
                    { r: 255, g: 255, b: 0 }    // yellow
                ];
            } else if (mode === 'blackWhiteColor') {
                palette = [
                    { r: 0, g: 0, b: 0 },       // black
                    { r: 255, g: 255, b: 255 }  // white
                ];
            } else if (mode === 'threeColor') {
                palette = [
                    { r: 0, g: 0, b: 0 },       // black
                    { r: 255, g: 255, b: 255 }, // white
                    { r: 255, g: 0, b: 0 }      // red
                ];
            }

            function findClosestColor(r, g, b) {
                let closestColor = palette[0];
                let minDistance = Infinity;

                for (const color of palette) {
                    const distance = Math.sqrt(
                        Math.pow(color.r - r, 2) +
                        Math.pow(color.g - g, 2) +
                        Math.pow(color.b - b, 2)
                    );

                    if (distance < minDistance) {
                        minDistance = distance;
                        closestColor = color;
                    }
                }

                return closestColor;
            }

            function adjustSaturationBrightnessContrast(r, g, b, saturation, brightness, contrast) {
                // 调整亮度
                r *= brightness;
                g *= brightness;
                b *= brightness;

                // 调整对比度
                r = (r - 128) * contrast + 128;
                g = (g - 128) * contrast + 128;
                b = (b - 128) * contrast + 128;

                // 调整饱和度
                const avg = (r + g + b) / 3;
                r = avg + (r - avg) * saturation;
                g = avg + (g - avg) * saturation;
                b = avg + (b - avg) * saturation;

                // 确保颜色值在 [0, 255] 范围内
                return {
                    r: Math.min(255, Math.max(0, r)),
                    g: Math.min(255, Math.max(0, g)),
                    b: Math.min(255, Math.max(0, b))
                };
            }

            // 更新调色板选择逻辑
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    const index = (y * width + x) * 4;
                    let r = data[index];
                    let g = data[index + 1];
                    let b = data[index + 2];

                    // 应用饱和度、亮度和对比度调节
                    const adjustedColor = adjustSaturationBrightnessContrast(r, g, b, saturation, brightness, contrast);
                    r = adjustedColor.r;
                    g = adjustedColor.g;
                    b = adjustedColor.b;

                    let closestColor;
                    if (mode === 'blackWhiteColor') {
                        const grayscale = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        closestColor = grayscale >= 128 ? palette[1] : palette[0];
                    } else {
                        closestColor = findClosestColor(r, g, b);
                    }

                    const newR = closestColor.r;
                    const newG = closestColor.g;
                    const newB = closestColor.b;

                    const errR = r - newR;
                    const errG = g - newG;
                    const errB = b - newB;

                    data[index] = newR;
                    data[index + 1] = newG;
                    data[index + 2] = newB;

                    // 错误传播（应用扩散程度）
                    if (x + 1 < width) {
                        data[index + 4] += errR * 7 / 16 * diffusion;
                        data[index + 5] += errG * 7 / 16 * diffusion;
                        data[index + 6] += errB * 7 / 16 * diffusion;
                    }
                    if (y + 1 < height) {
                        if (x > 0) {
                            data[index + (width - 1) * 4] += errR * 3 / 16 * diffusion;
                            data[index + (width - 1) * 4 + 1] += errG * 3 / 16 * diffusion;
                            data[index + (width - 1) * 4 + 2] += errB * 3 / 16 * diffusion;
                        }
                        data[index + width * 4] += errR * 5 / 16 * diffusion;
                        data[index + width * 4 + 1] += errG * 5 / 16 * diffusion;
                        data[index + width * 4 + 2] += errB * 5 / 16 * diffusion;
                        if (x + 1 < width) {
                            data[index + (width + 1) * 4] += errR * 1 / 16 * diffusion;
                            data[index + (width + 1) * 4 + 1] += errG * 1 / 16 * diffusion;
                            data[index + (width + 1) * 4 + 2] += errB * 1 / 16 * diffusion;
                        }
                    }
                }
            }
        }

        function processImageData(imageData) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const mode = ditherModeSelect.value;

            if (mode === 'sixColor') {
                // 每个像素4位，每两个像素一个字节
                const processedData = new Uint8Array(Math.ceil(width * height / 2));
                
                // 修正后的六色模式调色板索引
                const COLOR_BLACK = 0;   // 黑色
                const COLOR_WHITE = 1;   // 白色
                const COLOR_GREEN = 6;   // 绿色 (索引6)
                const COLOR_BLUE = 5;    // 蓝色 (索引5)
                const COLOR_RED = 3;     // 红色 (索引3)
                const COLOR_YELLOW = 2;  // 黄色 (索引2)
                
                // 六色模式的调色板（RGB值）
                const palette = [
                    [0, 0, 0],         // 黑色 (索引0)
                    [255, 255, 255],   // 白色 (索引1)
                    [255, 255, 0],     // 黄色 (索引2)
                    [255, 0, 0],       // 红色 (索引3)
                    [0, 0, 0],         // 未使用 (索引4)
                    [0, 0, 255],       // 蓝色 (索引5)
                    [0, 255, 0]        // 绿色 (索引6)
                ];

                // 将RGB值映射到修正后的调色板索引
                function findColorIndex(r, g, b) {
                    let minDist = Infinity;
                    let index = 0;
                    
                    for (let i = 0; i < palette.length; i++) {
                        // 跳过索引4（未使用）
                        if (i === 4) continue;
                        
                        const dr = r - palette[i][0];
                        const dg = g - palette[i][1];
                        const db = b - palette[i][2];
                        const dist = dr * dr + dg * dg + db * db;
                        
                        if (dist < minDist) {
                            minDist = dist;
                            index = i;
                        }
                    }
                    return index;
                }

                // 处理每个像素并打包到4位
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x += 2) {
                        // 第一个像素
                        const idx1 = (y * width + x) * 4;
                        const r1 = data[idx1];
                        const g1 = data[idx1 + 1];
                        const b1 = data[idx1 + 2];
                        const colorIndex1 = findColorIndex(r1, g1, b1);
                        
                        // 第二个像素 (如果存在)
                        let colorIndex2 = COLOR_WHITE; // 默认为白色
                        if (x + 1 < width) {
                            const idx2 = idx1 + 4;
                            const r2 = data[idx2];
                            const g2 = data[idx2 + 1];
                            const b2 = data[idx2 + 2];
                            colorIndex2 = findColorIndex(r2, g2, b2);
                        }
                        
                        // 将两个4位值组合成一个字节
                        const byte = (colorIndex1 << 4) | colorIndex2;
                        const byteIndex = Math.floor((y * width + x) / 2);
                        processedData[byteIndex] = byte;
                    }
                }
                
                return processedData;
            } 

            if (mode === 'fourColor') {
                const processedData = new Uint8Array(Math.ceil((width * height) / 4));

                function rgbToGray(r, g, b) {
                    if (r < 128 && g < 128 && b < 128) return 0x00;  // 黑色
                    if (r > 128 && g > 128 && b > 128) return 0x01;  // 白色
                    if (r > 128 && g > 128 && b < 128) return 0x02;  // 黄色
                    if (r > 128 && g < 128 && b < 128) return 0x03;  // 红色
                    return 0x01;  // 默认白色
                }

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = (y * width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        const grayValue = rgbToGray(r, g, b);
                        const newIndex = (y * width + x) / 4 | 0;
                        const shift = 6 - ((x % 4) * 2);
                        processedData[newIndex] |= (grayValue << shift);
                    }
                }

                return processedData;
            }

            else if (mode === 'blackWhiteColor') {
                const byteWidth = Math.ceil(width / 8);
                const processedData = new Uint8Array(byteWidth * height);
                const threshold = 128;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = (y * width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        const grayscale = Math.round(0.299 * r + 0.587 * g + 0.114 * b);
                        const bit = grayscale >= threshold ? 1 : 0;
                        const byteIndex = y * byteWidth + Math.floor(x / 8);
                        const bitIndex = 7 - (x % 8);
                        processedData[byteIndex] |= (bit << bitIndex);
                    }
                }

                return processedData;
            } else if (mode === 'threeColor') {
                const byteWidth = Math.ceil(width / 8);
                const blackWhiteData = new Uint8Array(height * byteWidth);
                const redWhiteData = new Uint8Array(height * byteWidth);
                const blackWhiteThreshold = 140;
                const redThreshold = 160;

                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const index = (y * width + x) * 4;
                        const r = data[index];
                        const g = data[index + 1];
                        const b = data[index + 2];
                        const grayscale = Math.round(0.299 * r + 0.587 * g + 0.114 * b);

                        // 黑白处理
                        const blackWhiteBit = grayscale >= blackWhiteThreshold ? 1 : 0;
                        const blackWhiteByteIndex = y * byteWidth + Math.floor(x / 8);
                        const blackWhiteBitIndex = 7 - (x % 8);
                        if (blackWhiteBit) {
                            blackWhiteData[blackWhiteByteIndex] |= (0x01 << blackWhiteBitIndex);
                        } else {
                            blackWhiteData[blackWhiteByteIndex] &= ~(0x01 << blackWhiteBitIndex);
                        }

                        // 红白处理
                        const redWhiteBit = (r > redThreshold && r > g && r > b) ? 0 : 1;
                        const redWhiteByteIndex = y * byteWidth + Math.floor(x / 8);
                        const redWhiteBitIndex = 7 - (x % 8);
                        if (redWhiteBit) {
                            redWhiteData[redWhiteByteIndex] |= (0x01 << redWhiteBitIndex);
                        } else {
                            redWhiteData[redWhiteByteIndex] &= ~(0x01 << redWhiteBitIndex);
                        }
                    }
                }

                const processedData = new Uint8Array(blackWhiteData.length + redWhiteData.length);
                processedData.set(blackWhiteData, 0);
                processedData.set(redWhiteData, blackWhiteData.length);

                return processedData;
            }
        }

        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 设置默认画布尺寸
            canvas.width = 122;
            canvas.height = 250;
            ctx.fillStyle = '#f8fafc';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#94a3b8';
            ctx.font = '16px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('上传图片后预览将显示在这里', canvas.width / 2, canvas.height / 2);

            // 初始化滑块值显示
            updateSliderValues();

            // 初始化状态信息
            updateStatusInfo();

            // 模式选择变化事件
            ditherModeSelect.addEventListener('change', updateStatusInfo);
        });
    </script>
</body>

</html>